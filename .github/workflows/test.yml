name: Auto comment on Push and Pull Request

on: 
  pull_request:
    branches: 
      - main
      - dev


jobs:

  # test_sonarqube_connection:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Check HTTP access to sonarqube 
  #       run: |
  #         curl -v http://54.158.35.213:9000 || echo "connection failed"
  #         echo "Hello Jee"

  comment_on_pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    env:
      json_comment: "PR Review: Component: hello, Project: scrapper_project"
    steps:
      - name: Run Code Analysis
        uses: sonarsource/sonarqube-scan-action@v5.2.0
        env:
          SONAR_TOKEN: sqa_acf14b025b0a8a8b841cf761b5267f9fc32fe544
          SONAR_HOST_URL: http://34.203.199.42:9000
        with:
          args: >
            -Dsonar.projectKey=scrapping_poc
            -Dsonar.sources=.
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }}
            -Dsonar.login=${{ env.SONAR_TOKEN }}
            -Dsonar.ws.timeout=300
            -Dsonar.ce.ws.timeout=300


          # args: -Dsonar.projectKey=scrapping_poc
      - name: Comment on pull request
        run: |
          PR_NUMBER=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")
          COMMENT_URL="https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments"

          curl -i -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"body\": \"${json_comment}\"}" \
            "$COMMENT_URL"

  

name: Auto comment on Push and Pull Request

on: 
  pull_request:
    branches: 
      - dev

jobs:
  comment_on_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Code Analysis
        uses: sonarsource/sonarqube-scan-action@v5.2.0
        env:
          SONAR_TOKEN: sqa_acf14b025b0a8a8b841cf761b5267f9fc32fe544
          SONAR_HOST_URL: http://54.198.91.154:9000
        with:
          args: >
            -Dsonar.projectKey=scrapping_poc
            -Dsonar.sources=.
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }}
            -Dsonar.login=${{ env.SONAR_TOKEN }}

      - name: Fetch SonarQube metrics
        env:
          SONAR_TOKEN: sqa_acf14b025b0a8a8b841cf761b5267f9fc32fe544
          SONAR_HOST_URL: http://54.198.91.154:9000
        id: sonarqube
        run: |
          echo "Fetching SonarQube metrics..."
          RESPONSE=$(curl -s -u "${{ env.SONAR_TOKEN }}:" \
            "${{ env.SONAR_HOST_URL }}/api/measures/component?component=scrapping_poc&metricKeys=alert_status")
          
          echo "SonarQube raw response $RESPONSE"
          
          ALERT_STATUS=$(echo "$RESPONSE" | jq -r '.component.measures[] | select(.metric=="alert_status") | .value // "UNKNOWN"')


          echo "Parsed metrics:"
          echo "ALERT_STATUS=$ALERT_STATUS"

          echo "ALERT_STATUS=$ALERT_STATUS" >> $GITHUB_ENV

  
      - name: Create/update & apply SonarQube label
        run: |
          PR_NUMBER=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")

          if [[ "${{ env.ALERT_STATUS }}" == "ERROR" ]]; then
            LABEL_NAME="sonarqube_failed"
            LABEL_COLOR="d73a4a"  # Red
          else
            LABEL_NAME="sonarqube_passed"
            LABEL_COLOR="0e8a16"  # Green
          fi

          LABEL_API_URL="https://api.github.com/repos/${{ github.repository }}/labels/$LABEL_NAME"

          # Check if the label exists
          STATUS_CODE=$(curl -s -o response.json -w "%{http_code}" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$LABEL_API_URL")

          if [[ "$STATUS_CODE" == "200" ]]; then
            echo "Label exists. Updating color..."
            curl -s -X PATCH "$LABEL_API_URL" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg name "$LABEL_NAME" --arg color "$LABEL_COLOR" '{name: $name, color: $color}')"
          else
            echo "Label does not exist. Creating label..."
            curl -s -X POST "https://api.github.com/repos/${{ github.repository }}/labels" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg name "$LABEL_NAME" --arg color "$LABEL_COLOR" '{name: $name, color: $color}')"
          fi

          # Remove any old SonarQube labels
          for label in sonarqube_failed sonarqube_passed; do
            curl -s -X DELETE "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/labels/$label" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" || true
          done

          # Apply the correct label to the PR
          curl -s -X POST "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/labels" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg label "$LABEL_NAME" '[$label]')"
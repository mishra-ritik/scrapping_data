name: Auto comment on Push and Pull Request

on: 
  pull_request:
    branches: 
      - dev

jobs:
  comment_on_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set Executable Permissions
        run: chmod +x .github/scripts/*.sh

      - name: Fetch SonarQube metrics
        env:
          SONAR_TOKEN: sqa_d6528deb2bd094bf1fc06cf85d8edd30f213622f
          SONAR_HOST_URL: https://sonarqube.paltechops.org
        run: .github/scripts/fetch_sonar_metrics.sh
  
      - name: Manage and Apply Labels
        env: 
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
        run: |
          PARAM_COLOR="f9d423" #yellow
          if [[ "${{ env.ALERT_STATUS }}" == "ERROR" ]]; then
            SONAR_LABEL="sonarqube_failed"
            SONAR_COLOR="d73a4a" #red
          else
            SONAR_LABEL="sonarqube_passed"
            SONAR_COLOR="0e8a16" #green
          fi

          .github/scripts/manage_labels.sh "$SONAR_LABEL" "$SONAR_COLOR"
          .github/scripts/remove_labels.sh sonarqube_failed sonarqube_passed duplications:*
          .github/scripts/apply_labels.sh "$SONAR_LABEL"

          .github/scripts/manage_labels.sh "issues:${{ env.NEW_ISSUES }}" "$PARAM_COLOR"
          .github/scripts/apply_labels.sh "issues:${{ env.NEW_ISSUES }}"

          # .github/scripts/manage_labels.sh "duplications:${{ env.DUPLICATIONS }}" "$PARAM_COLOR"
          # .github/scripts/apply_labels.sh "duplications:${{ env.DUPLICATIONS }}"

          .github/scripts/manage_labels.sh "security:${{ env.SECURITY_HOTSPOTS }}" "$PARAM_COLOR"
          .github/scripts/apply_labels.sh "security:${{ env.SECURITY_HOTSPOTS }}"